<html>
	<head>
		<title>Options — Send to Prowl</title>
		<style>
		#status {
			display: none;
			background: yellow;
			color: black;
			padding: 1em;
		}
		
		#status.visible {
			display: block;
		}
		
		#status.ok {
			background: green;
			color: white;
		}
		
		#status.error {
			background: red;
			color: white;
		}

		body {
			font: 13px Helvetica, sans-serif;
			padding: 16px;
		}
		
		h1 {
			font-weight: normal;
			font-size: 200%;
			color: #53637D;
			text-shadow: white 0 1px 2px;
			margin: 0;
			padding: 0 0 4px 0; 
		}

		.page {
			width: 800px;
			display: table;
		}
		
		.page > section {
			display: table-row;
		}

		.page > section > * {
			display: table-cell;
			vertical-align: baseline;
			padding: 17px 0 20px 0;
			border-top: 1px solid #eee;
		}

		.page > section > h3 {
			font-size: 105%;
		}
		
		.page label {
			margin: 5px 0;
		}
		
		.page label.radio {
			display: block;
		}

		.page td,
		.page th {
			text-align: left;
			font-size: 0.8em;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			padding: 5px;
		}

		#history td:nth-child(1) {
			width: 450px;
		}

		#history td:nth-child(2) {
			width: 200px;
		}

		</style>
	</head>
	<body>
		<h1>Send to Prowl</h1>
		<div id="status"></div>
		<div class="page">
			<section>
				<h3>Behavior</h3>
				<div>
					<label class="radio">
						<input type="checkbox" id="close_tab">
						<span>Close the tab after the url has been sent.</span>
					</label>
					<label class="radio">
						<input type="checkbox" id="show_notification">
						<span>Show a popup notification when the url has been sent.</span>
					</label>
				</div>
			</section>
			<section>
				<h3>Prowl</h3>
				<label>
					<span>API Key:</span>
					<input id="api_key" type="text" size="50">
					<button id="request_api_key_button">Connect with Prowl</button>
				</label>
			</section>
			<section>
				<h3>History</h3>
				<div>
					<table id="history">
						<thead>
							<tr>
								<th>Title</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</section>
		</div>
	</body>
	<script>
		var api_key_el = document.getElementById('api_key');
		var close_tab_el = document.getElementById('close_tab');
		var show_notification_el = document.getElementById('show_notification');
		var status_el = document.getElementById('status');
		var request_api_key_button_el = document.getElementById('request_api_key_button');
		var history_el = document.querySelector('#history tbody');
		var clear_status;
		
		function urlencode(data)
		{
			var pairs = [];
			
			for (var key in data)
				pairs.push(encodeURIComponent(key) + "=" + encodeURIComponent(data[key]));
			
			return pairs.join('&');
		}
		
		function Prowl()
		{
			this.provider_key = 'c8f364809d533a1fee2ebeaf87040fc600f37201';
			this.host = "https://api.prowlapp.com/publicapi/";
		}
		
		Prowl.prototype.call = function(method, action, data, onresponse)
		{
			var body = urlencode(data);
			
			var request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if (request.readyState == 4)
					onresponse(request);
			}
			
			if (method == 'GET')
			{
				request.open('GET', this.host + action + '?' + body, true);
				request.send();
			}
			else
			{
				request.open('POST', this.host + action, true);
				request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
				request.send(body);
			}
		}
		
		Prowl.prototype.validateApiKey = function(key, onresponse)
		{
			this.call('GET', 'verify',
				{
					'providerkey': this.provider_key,
					'apikey': key
				},
				function(response) {
					onresponse(response.responseXML.getElementsByTagName('success').length > 0);
				});
		}
		
		Prowl.prototype.requestToken = function(onresponse)
		{
			this.call('GET', 'retrieve/token',
				{
					'providerkey': this.provider_key
				},
				function(response) {
					if (response.responseXML.getElementsByTagName('error') > 0)
						onresponse(false);
					else
						onresponse({
							'token': response.responseXML.getElementsByTagName('retrieve')[0].getAttribute('token'),
							'url': response.responseXML.getElementsByTagName('retrieve')[0].getAttribute('url')
						});
				});
		}
		
		Prowl.prototype.requestKey = function(token, onresponse)
		{
			this.call('GET', 'retrieve/apikey',
				{
					'providerkey': this.provider_key,
					'token': token
				},
				function(response) {
					if (response.responseXML.getElementsByTagName('error').length > 0)
						onresponse(false);
					else
						onresponse(response.responseXML.getElementsByTagName('retrieve')[0].getAttribute('apikey'));
				});
		}
		
		var prowl = new Prowl();
		
		function load()
		{
			api_key_el.value = localStorage['api_key'] || '';
			close_tab_el.checked = JSON.parse(localStorage['close_tab']);
			show_notification_el.checked = JSON.parse(localStorage['show_notification']);
			loadHistory();
		}
		
		function saveApiKey(onsuccess, onerror)
		{
			var api_key = api_key_el.value;
			
			if (api_key.length == 0)
			{
				localStorage['api_key'] = '';
				onsuccess();
			}
			else if (api_key.length == 40)
			{
				prowl.validateApiKey(api_key, function(success) {
					if (success)
					{
						localStorage['api_key'] = api_key;
						onsuccess();
					}
					else
						onerror();
				});
			}
			else
				onerror();
		}
		
		function status(message, level)
		{
			clearTimeout(clear_status);
			status_el.innerText = message;
			status_el.className = 'visible ' + level;
			clear_status = setTimeout(function() {
				status_el.className = '';
			}, 5000);
		}
		
		api_key_el.addEventListener('keydown', function(e)
		{
			switch (e.keyCode)
			{
				case 27: // esc
					load();
					e.preventDefault();
					break;
				case 13: // enter
					status('Validating Key…', '');
					saveApiKey(
						function() { status('API Key Saved', 'ok'); },
						function() { status('Invalid API Key', 'error'); });
					e.preventDefault();
					break;
			}
		});
		
		close_tab_el.addEventListener('change', function(e)
		{
			localStorage['close_tab'] = JSON.stringify(close_tab_el.checked);
		});
	   
		show_notification_el.addEventListener('change', function(e)
		{
			localStorage['show_notification'] = JSON.stringify(show_notification_el.checked);
		});
		
		var token = null;
		
		request_api_key_button_el.addEventListener('click', function(e)
		{
			request_api_key_button_el.disabled = true;
			prowl.requestToken(function(response) {
				if (!response)
				{
					status('Could not retrieve token used to request the key', 'error');
					request_api_key_button_el.disabled = false;
					return;
				}
				
				token = response.token;
				chrome.tabs.create(
					{
						'url': response.url
					},
					function(tab) {
						chrome.tabs.onUpdated.addListener(function(aTab, data) {
							if (aTab != tab.id || !data.url) // only detect url changes of 'our' tab
								return;
							
							if (data.url.indexOf('?do=permit') == -1) // only the 'checkout' page
								return;
								
							prowl.requestKey(token, function(api_key) {
								if (api_key)
								{
									localStorage['api_key'] = api_key;
									status('Key saved', 'ok');
									load();
								}
								else
								{
									status('An error occurred while trying to retrieve the key', 'error');
								}
								
								request_api_key_button_el.disabled = false;
							});
							
							chrome.tabs.remove(aTab);
						});
						
						chrome.tabs.onRemoved.addListener(function(aTab) {
							if (tab.id == aTab)
							{
								status('Key request aborted because the tab was closed', '');
								request_api_key_button_el.disabled = false;
							}
						});
					});
				
				status('See the other Prowl tab thingy');
			});
		});

		function loadHistory()
		{
			history_el.innerHTML = '';

			var history = JSON.parse(localStorage['history'] || '[]');

			for (var i = history.length - 1; i >= 0; --i)
			{
				var row_el = document.createElement('tr'),
					title_cell_el = document.createElement('td'),
					date_cell_el = document.createElement('td'),
					link_el = document.createElement('a'),
					date_el = document.createElement('time');
				
				row_el.appendChild(title_cell_el);
				row_el.appendChild(date_cell_el);
			
				title_cell_el.appendChild(link_el);
				date_cell_el.appendChild(date_el);

				link_el.href = history[i].link;
				link_el.appendChild(document.createTextNode(history[i].title));

				date_el.appendChild(document.createTextNode(new Date(history[i].date).toLocaleDateString()));

				history_el.appendChild(row_el);
			}
		}

		load();
	</script>
</html>